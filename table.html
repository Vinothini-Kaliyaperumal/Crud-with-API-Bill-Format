<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Page</title>
    <link rel="stylesheet" href="table.css">
    <script src="table.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container tab">
        <h2 class="details text-center text-black ">Customer Profile</h2>
        
        <div class=" mt-4 table-responsive p-4 card">
          <table class="table-striped table " id="table">
            <thead>
              <tr>
                <th>Customer Name</th>
                <th>Purchase Date</th>
                <th>Phone Num</th>
                <th>Email</th>
                <th>Address</th>
                <th>Gender</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="tabledata">
            </tbody>
          </table>
        </div>
      </div>
</body>
</html> -->



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing System</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
</head>
<body>
    <div class="container">
        <h2>Billing System</h2>
        <form id="billing-form">
            <table id="bill-table" class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be added here -->
                </tbody>
            </table>
            <button type="button" id="add" class="btn btn-primary">Add Row</button>
            <hr>
            <div>
                <p>Subtotal: $<span id="subtotal">0.00</span></p>
                <p>GST (5%): $<span id="gst">0.00</span></p>
                <p>Discount (10%): -$<span id="discount">0.00</span></p>
                <p>Total: $<span id="total">0.00</span></p>
            </div>
            <button type="submit" class="btn btn-success">Submit</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const addRowButton = document.getElementById("add");
            const billTable = document.getElementById("bill-table").getElementsByTagName('tbody')[0];
            const subtotalEl = document.getElementById("subtotal");
            const gstEl = document.getElementById("gst");
            const discountEl = document.getElementById("discount");
            const totalEl = document.getElementById("total");

            addRowButton.addEventListener("click", addRow);

            function addRow() {
                const newRow = billTable.insertRow();
                newRow.innerHTML = `
                    <td>
                        <select class="form-control" name="productName" onchange="setPrice(this)">
                            <option value="" data-price="0">Select a product</option>
                            <option value="Headphones" data-price="19">Headphones</option>
                            <option value="Laptop" data-price="799">Laptop</option>
                            <option value="Wireless Mouse" data-price="24">Wireless Mouse</option>
                            <option value="Smartwatch" data-price="129">Smartwatch</option>
                            <option value="Gaming Keyboard" data-price="49">Gaming Keyboard</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control" name="quantity" placeholder="Enter quantity" required>
                    </td>
                    <td>
                        <input type="number" class="form-control" name="price" placeholder="Enter price" readonly>
                    </td>
                    <td>
                        <input type="number" class="form-control" name="totalAmount" placeholder="Enter total" readonly>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger delete-button" onclick="deleteRow(this)">Delete</button>
                    </td>
                `;
            }

            function setPrice(selectElement) {
                const price = selectElement.options[selectElement.selectedIndex].getAttribute("data-price");
                const row = selectElement.closest("tr");
                const priceInput = row.querySelector("input[name='price']");
                const quantityInput = row.querySelector("input[name='quantity']");
                const totalAmountInput = row.querySelector("input[name='totalAmount']");

                priceInput.value = price;
                quantityInput.addEventListener("input", () => {
                    totalAmountInput.value = quantityInput.value * price;
                    calculateTotals();
                });
                calculateTotals();
            }

            function calculateTotals() {
                let subtotal = 0;
                billTable.querySelectorAll("tr").forEach(row => {
                    const totalAmount = parseFloat(row.querySelector("input[name='totalAmount']").value) || 0;
                    subtotal += totalAmount;
                });

                const gst = subtotal * 0.05;
                const discount = subtotal * 0.10;
                const total = subtotal + gst - discount;

                subtotalEl.textContent = subtotal.toFixed(2);
                gstEl.textContent = gst.toFixed(2);
                discountEl.textContent = discount.toFixed(2);
                totalEl.textContent = total.toFixed(2);
            }

            window.setPrice = setPrice;

            function deleteRow(button) {
                const row = button.closest("tr");
                row.remove();
                calculateTotals();
            }

            window.deleteRow = deleteRow;

            const billingForm = document.getElementById("billing-form");
            billingForm.addEventListener("submit", handleSubmit);

            function handleSubmit(event) {
                event.preventDefault();

                const rows = billTable.querySelectorAll('tr');
                const items = [];
                rows.forEach(row => {
                    const productName = row.querySelector("select[name='productName']").value;
                    const quantity = row.querySelector("input[name='quantity']").value;
                    const price = row.querySelector("input[name='price']").value;
                    const totalAmount = row.querySelector("input[name='totalAmount']").value;
                    if (productName && quantity && price && totalAmount) {
                        items.push({ productName, quantity, price, totalAmount });
                    }
                });

                const payload = {
                    items,
                    subtotal: subtotalEl.textContent,
                    gst: gstEl.textContent,
                    discount: discountEl.textContent,
                    total: totalEl.textContent
                };

                fetch('http://localhost:8080/api/invoice/buy/product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(`API Error: ${data.error.code} - ${data.error.reason}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Success:', data);
                    alert('Order placed successfully!');
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.message.includes('409 CONFLICT')) {
                        alert('Conflict occurred. Please check your data for duplicates or inconsistencies.');
                    } else if (error.message.includes('400 BAD_REQUEST')) {
                        alert('Invalid data. Please check your inputs.');
                    } else {
                        alert('An error occurred. Please try again later.');
                    }
                });
            }
        });
    </script>
</body>
</html>
